<?xml version="1.0" encoding="UTF-8"?>
<!--
  Resource Definition: Application métier multi-base
  Cette ressource nécessite un connecteur customisé qui permet de provisionner plusieurs bases en même temps :
  
  1. LDAP : Groupes LDAP
     - AppBiz_CustomGR_User
     - AppBiz_CustomGR2_Manager
     - AppBiz_CustomGR2_Admin
     - AppBiz_CustomGR2_Audit
  
  2. Base SQL PostgreSQL : Tables
     - users (user_id, User_ldap_dn, User_ldap_class, user_id, firstname, lastname, commonname, email, brithdate)
     - profiles (profile_id, profile_name)
     - user_profile_id_permissions (urp_id, user_id, profile_id, permission_name, is_allowed, assigned_at)
  
  3. Base NoSQL : Supabase/Firebase
     - Collection users avec structure JSON
  
  Note: Cette configuration nécessite un connecteur customisé multi-ressource.
  Pour l'instant, on définit la structure de chaque composant.
-->
<resource oid="8a83b1a4-be18-11e6-ae84-7301fdab1d85"
          xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3"
          xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
          xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
          xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3"
          xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">

    <name>Application Métier Multi-Base</name>
    <description>Application métier multi-base : LDAP + PostgreSQL + NoSQL (Supabase/Firebase)</description>

    <!-- 
      Note: Pour une implémentation complète, il faudrait un connecteur customisé
      qui gère simultanément LDAP, PostgreSQL et NoSQL.
      Cette configuration définit la structure attendue.
    -->
    <connectorRef type="ConnectorType">
        <filter>
            <q:equal>
                <q:path>connectorType</q:path>
                <!-- Connecteur customisé à développer -->
                <q:value>com.custom.connector.multibase.MultiBaseConnector</q:value>
            </q:equal>
        </filter>
    </connectorRef>

    <connectorConfiguration
            xmlns:icfcmb="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.custom.connector-multibase/com.custom.connector.multibase.MultiBaseConnector">
        <icfc:configurationProperties>
            
            <!-- Configuration LDAP -->
            <icfcmb:ldapHost>openldap</icfcmb:ldapHost>
            <icfcmb:ldapPort>389</icfcmb:ldapPort>
            <icfcmb:ldapBaseDn>dc=example,dc=com</icfcmb:ldapBaseDn>
            <icfcmb:ldapBindDn>cn=admin,dc=example,dc=com</icfcmb:ldapBindDn>
            <icfcmb:ldapBindPassword>
                <t:clearValue>admin</t:clearValue>
            </icfcmb:ldapBindPassword>
            
            <!-- Configuration PostgreSQL -->
            <icfcmb:postgresHost>intranet-db</icfcmb:postgresHost>
            <icfcmb:postgresPort>5432</icfcmb:postgresPort>
            <icfcmb:postgresDatabase>appbiz</icfcmb:postgresDatabase>
            <icfcmb:postgresUser>appbiz</icfcmb:postgresUser>
            <icfcmb:postgresPassword>
                <t:clearValue>appbiz123</t:clearValue>
            </icfcmb:postgresPassword>
            
            <!-- Configuration NoSQL (Supabase/Firebase) -->
            <icfcmb:nosqlType>supabase</icfcmb:nosqlType>
            <icfcmb:nosqlUrl>http://supabase:54321</icfcmb:nosqlUrl>
            <icfcmb:nosqlApiKey>
                <t:clearValue>your-api-key</t:clearValue>
            </icfcmb:nosqlApiKey>
            
        </icfc:configurationProperties>
    </connectorConfiguration>

    <schemaHandling>
        <!-- Configuration pour les comptes utilisateurs multi-base -->
        <objectType>
            <kind>account</kind>
            <intent>default</intent>
            <displayName>Multi-Base User Account</displayName>
            <default>true</default>
            <objectClass>ri:AccountObjectClass</objectClass>

            <!-- LDAP DN -->
            <attribute>
                <ref>ri:ldap_dn</ref>
                <displayName>LDAP Distinguished Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                    <expression>
                        <script>
                            <code>
                                import javax.naming.ldap.Rdn
                                def first = givenName?.toString()?.toLowerCase()?.replaceAll("[^a-z0-9]", "")
                                def last = familyName?.toString()?.toLowerCase()?.replaceAll("[^a-z0-9]", "")
                                if (!first || !last) return null
                                def uid = first + "." + last
                                return "uid=" + Rdn.escapeValue(uid) + ",ou=users,dc=example,dc=com"
                            </code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <!-- LDAP Class -->
            <attribute>
                <ref>ri:ldap_class</ref>
                <displayName>LDAP Object Class</displayName>
                <outbound>
                    <strength>strong</strength>
                    <expression>
                        <value>inetOrgPerson</value>
                    </expression>
                </outbound>
            </attribute>

            <!-- User ID (pour SQL et NoSQL) -->
            <attribute>
                <ref>ri:user_id</ref>
                <displayName>User ID</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/personalNumber</path>
                    </source>
                </outbound>
            </attribute>

            <!-- First Name -->
            <attribute>
                <ref>ri:firstname</ref>
                <displayName>First Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                </outbound>
            </attribute>

            <!-- Last Name -->
            <attribute>
                <ref>ri:lastname</ref>
                <displayName>Last Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                </outbound>
            </attribute>

            <!-- Common Name -->
            <attribute>
                <ref>ri:commonname</ref>
                <displayName>Common Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                    <expression>
                        <script>
                            <code>return givenName + ' ' + familyName</code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <!-- Email -->
            <attribute>
                <ref>ri:email</ref>
                <displayName>Email</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/emailAddress</path>
                    </source>
                </outbound>
            </attribute>

            <!-- Birth Date -->
            <attribute>
                <ref>ri:brithdate</ref>
                <displayName>Birth Date</displayName>
                <outbound>
                    <strength>weak</strength>
                    <source>
                        <path>$user/extension/dateOfBirth</path>
                    </source>
                    <expression>
                        <script>
                            <code>
                                if (dateOfBirth == null) return null
                                // Format YYYY-MM-DD
                                return dateOfBirth.toString().substring(0, 10)
                            </code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <!-- Association aux groupes LDAP -->
            <association>
                <ref>ri:ldap_groups</ref>
                <displayName>LDAP Groups</displayName>
                <kind>entitlement</kind>
                <intent>ldap_group</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:member</associationAttribute>
                <valueAttribute>ri:cn</valueAttribute>
            </association>

            <!-- Association aux profils PostgreSQL -->
            <association>
                <ref>ri:profiles</ref>
                <displayName>PostgreSQL Profiles</displayName>
                <kind>entitlement</kind>
                <intent>profile</intent>
                <direction>subjectToObject</direction>
                <associationAttribute>ri:profile_id</associationAttribute>
                <valueAttribute>ri:profile_id</valueAttribute>
            </association>

        </objectType>

        <!-- Configuration pour les groupes LDAP -->
        <objectType>
            <kind>entitlement</kind>
            <intent>ldap_group</intent>
            <displayName>LDAP Group</displayName>
            <objectClass>ri:groupOfNames</objectClass>
            
            <attribute>
                <ref>ri:cn</ref>
                <displayName>Group CN</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$focus/name</path>
                    </source>
                </outbound>
            </attribute>
            
        </objectType>

        <!-- Configuration pour les profils PostgreSQL -->
        <objectType>
            <kind>entitlement</kind>
            <intent>profile</intent>
            <displayName>PostgreSQL Profile</displayName>
            <objectClass>ri:ProfileObjectClass</objectClass>
            
            <attribute>
                <ref>ri:profile_id</ref>
                <displayName>Profile ID</displayName>
            </attribute>
            
            <attribute>
                <ref>ri:profile_name</ref>
                <displayName>Profile Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$focus/name</path>
                    </source>
                </outbound>
            </attribute>
            
        </objectType>

    </schemaHandling>

</resource>
