<?xml version="1.0" encoding="UTF-8"?>
<!--
  Resource Definition: OpenLDAP
  Système cible pour le provisioning des comptes utilisateurs
  
  Ce fichier définit comment MidPoint provisionne les utilisateurs
  vers le serveur LDAP OpenLDAP.
-->
<resource oid="8a83b1a4-be18-11e6-ae84-7301fdab1d7d"
          xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
          xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3"
          xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
          xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">

    <name>OpenLDAP</name>
    <description>Serveur LDAP OpenLDAP pour authentification et gestion des groupes</description>

    <!-- Configuration du connecteur LDAP -->
    <connectorRef type="ConnectorType">
        <filter>
            <q:equal>
                <q:path>connectorType</q:path>
                <q:value>com.evolveum.polygon.connector.ldap.LdapConnector</q:value>
            </q:equal>
        </filter>
    </connectorRef>

    <connectorConfiguration
            xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
        <icfc:configurationProperties
                xmlns:icfcldap="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-ldap/com.evolveum.polygon.connector.ldap.LdapConnector">
            
            <!-- Hôte LDAP -->
            <icfcldap:host>openldap</icfcldap:host>
            <icfcldap:port>389</icfcldap:port>
            
            <!-- Base DN -->
            <icfcldap:baseContext>dc=example,dc=com</icfcldap:baseContext>
            
            <!-- Compte de connexion (bind DN) -->
            <icfcldap:bindDn>cn=admin,dc=example,dc=com</icfcldap:bindDn>
            <icfcldap:bindPassword>
                <t:clearValue>admin</t:clearValue>
            </icfcldap:bindPassword>
            
            <!-- Mode de connexion -->
            <icfcldap:connectionSecurity>none</icfcldap:connectionSecurity>
            
        </icfc:configurationProperties>
    </connectorConfiguration>

    <!-- Schéma: définition des attributs et mappings -->
    <schemaHandling>
        <!-- Configuration pour les comptes utilisateurs (inetOrgPerson) -->
        <objectType>
            <kind>account</kind>
            <intent>default</intent>
            <displayName>LDAP User Account</displayName>
            <default>true</default>
            
            <objectClass>ri:inetOrgPerson</objectClass>

            <!-- Attribut DN (distinguished name) -->
            <attribute>
                <ref>ri:dn</ref>
                <displayName>Distinguished Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                    <expression>
                        <script>
                            <code>import javax.naming.ldap.Rdn; def first = givenName?.toString()?.toLowerCase()?.replaceAll("[^a-z0-9]", ""); def last = familyName?.toString()?.toLowerCase()?.replaceAll("[^a-z0-9]", ""); if (first == null || first.isEmpty() || last == null || last.isEmpty()) { return null; }; def uid = first + "." + last; return "uid=" + Rdn.escapeValue(uid) + ",ou=users,dc=example,dc=com";</code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <!-- Attribut uid (login) -->
            <attribute>
                <ref>ri:uid</ref>
                <displayName>Login (uid)</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                    <expression>
                        <script>
                            <code>def first = givenName?.toString()?.toLowerCase()?.replaceAll("[^a-z0-9]", ""); def last = familyName?.toString()?.toLowerCase()?.replaceAll("[^a-z0-9]", ""); if (first == null || first.isEmpty() || last == null || last.isEmpty()) { return null; }; return first + "." + last;</code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <!-- Attribut cn (common name) -->
            <attribute>
                <ref>ri:cn</ref>
                <displayName>Common Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                    <expression>
                        <script>
                            <code>return givenName + ' ' + familyName</code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <!-- Attribut sn (surname) -->
            <attribute>
                <ref>ri:sn</ref>
                <displayName>Surname</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                </outbound>
            </attribute>

            <!-- Attribut givenName -->
            <attribute>
                <ref>ri:givenName</ref>
                <displayName>Given Name</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                </outbound>
            </attribute>

            <!-- Attribut mail -->
            <attribute>
                <ref>ri:mail</ref>
                <displayName>Email</displayName>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$user/emailAddress</path>
                    </source>
                </outbound>
            </attribute>

            <!-- Association aux groupes LDAP -->
            <association>
                <ref>ri:group</ref>
                <displayName>LDAP Group Membership</displayName>
                <kind>entitlement</kind>
                <intent>group</intent>
                <direction>objectToSubject</direction>
                <associationAttribute>ri:member</associationAttribute>
                <valueAttribute>ri:dn</valueAttribute>
            </association>

        </objectType>

        <!-- Configuration pour les groupes LDAP -->
        <objectType>
            <kind>entitlement</kind>
            <intent>group</intent>
            <displayName>LDAP Group</displayName>
            <objectClass>ri:groupOfNames</objectClass>
            
            <attribute>
                <ref>ri:dn</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$focus/name</path>
                    </source>
                    <expression>
                        <script>
                            <code>import javax.naming.ldap.Rdn; return 'cn=' + Rdn.escapeValue(name.toString()) + ',ou=groups,dc=example,dc=com'</code>
                        </script>
                    </expression>
                </outbound>
            </attribute>
            
            <attribute>
                <ref>ri:cn</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$focus/name</path>
                    </source>
                </outbound>
            </attribute>
            
            <attribute>
                <ref>ri:description</ref>
                <outbound>
                    <strength>strong</strength>
                    <source>
                        <path>$focus/description</path>
                    </source>
                </outbound>
            </attribute>

            <!-- groupOfNames exige au moins un member : membre factice pour création du groupe -->
            <attribute>
                <ref>ri:member</ref>
                <displayName>Group Members</displayName>
                <fetchStrategy>explicit</fetchStrategy>
                <outbound>
                    <strength>weak</strength>
                    <expression>
                        <value>cn=dummy,ou=users,dc=example,dc=com</value>
                    </expression>
                </outbound>
            </attribute>
            
        </objectType>
    </schemaHandling>

</resource>

