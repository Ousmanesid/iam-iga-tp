================================================================================
    DOCUMENTATION TECHNIQUE - TP IAM AVANCÃ‰
    Workflows d'approbation, Connecteurs et Chatbot IA
================================================================================

ğŸ“‹ VUE D'ENSEMBLE DE L'ARCHITECTURE
================================================================================

L'architecture implÃ©mentÃ©e comprend les composants suivants:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ARCHITECTURE IAM COMPLÃˆTE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  Odoo RH    â”‚  CSV               â”‚  Salesforce â”‚  (API)                  â”‚
â”‚  â”‚  (Source)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (Source)   â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚                                  â”‚                                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                        â–¼                                                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚              â”‚    MIDPOINT     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚  (Central IAM)  â”‚                        â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚                   â”‚
â”‚                       â”‚                                 â”‚                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                   â”‚
â”‚         â–¼             â–¼             â–¼                  â”‚                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                   â”‚
â”‚   â”‚ Apache   â”‚  â”‚  Odoo    â”‚  â”‚ Gateway  â”‚            â”‚                   â”‚
â”‚   â”‚   DS     â”‚  â”‚  User    â”‚  â”‚  HTTP    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”               â”‚
â”‚   â”‚ (LDAP)   â”‚  â”‚ (Target) â”‚  â”‚ (Python) â”‚            â”‚   â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚   â”‚               â”‚
â”‚                                    â”‚                   â”‚   â”‚               â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚               â”‚
â”‚                      â–¼             â–¼             â–¼    â”‚   â”‚               â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚               â”‚
â”‚                â”‚ Home App â”‚  â”‚ Supabase â”‚  â”‚   N8N   â”‚â”‚   â”‚               â”‚
â”‚                â”‚PostgreSQLâ”‚  â”‚ (Cloud)  â”‚  â”‚Workflowsâ”‚â”‚   â”‚               â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚   â”‚               â”‚
â”‚                                                  â”‚     â”‚   â”‚               â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚               â”‚
â”‚                                    â–¼                   â”‚   â”‚               â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚               â”‚
â”‚                              â”‚  Chatbot  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚               â”‚
â”‚                              â”‚    IA     â”‚                 â”‚               â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚               â”‚
â”‚                                    â”‚                       â”‚               â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚               â”‚
â”‚                         â–¼                     â–¼            â”‚               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚               â”‚
â”‚                   â”‚ LLM Cloudâ”‚          â”‚LLM Local â”‚       â”‚               â”‚
â”‚                   â”‚(OpenAI)  â”‚          â”‚ (Ollama) â”‚       â”‚               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚               â”‚
â”‚                                                            â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”‚ UTILISATEURS                                                            â”‚
â”‚  â”‚  â€¢ Managers (demandes via Chatbot)                                      â”‚
â”‚  â”‚  â€¢ RH (approbations workflows)                                          â”‚
â”‚  â”‚  â€¢ IT Admin (configuration)                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸ“ STRUCTURE DES FICHIERS CRÃ‰Ã‰S
================================================================================

/iam-iga-tp/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ homeapp/
â”‚   â”‚   â”œâ”€â”€ init.sql                    # SchÃ©ma PostgreSQL Home App
â”‚   â”‚   â””â”€â”€ supabase-schema.sql         # SchÃ©ma Ã©quivalent pour Supabase
â”‚   â”œâ”€â”€ midpoint/
â”‚   â”‚   â”œâ”€â”€ resources/
â”‚   â”‚   â”‚   â””â”€â”€ resource-homeapp-postgresql.xml  # Connecteur PostgreSQL
â”‚   â”‚   â””â”€â”€ roles/
â”‚   â”‚       â”œâ”€â”€ role-homeapp-user.xml       # RÃ´le utilisateur de base
â”‚   â”‚       â”œâ”€â”€ role-homeapp-admin.xml      # RÃ´le admin (avec approbation)
â”‚   â”‚       â””â”€â”€ role-homeapp-commercial.xml # RÃ´le ABAC commercial
â”‚   â””â”€â”€ n8n/
â”‚       â””â”€â”€ workflows/
â”‚           â”œâ”€â”€ pre-provision-simple.json   # Workflow 1 Ã©tape
â”‚           â”œâ”€â”€ pre-provision-multi.json    # Workflow multi-Ã©tapes
â”‚           â”œâ”€â”€ post-provision.json         # Workflow post-provisioning
â”‚           â””â”€â”€ chatbot-action.json         # Workflow chatbot
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ env.example
â”‚   â”œâ”€â”€ main.py                         # Point d'entrÃ©e FastAPI
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ config.py                   # Configuration
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â”œâ”€â”€ user.py                 # ModÃ¨les utilisateurs
â”‚       â”‚   â””â”€â”€ request.py              # ModÃ¨les workflows/chatbot
â”‚       â”œâ”€â”€ routers/
â”‚       â”‚   â”œâ”€â”€ provision.py            # API provisioning
â”‚       â”‚   â”œâ”€â”€ workflow.py             # API workflows
â”‚       â”‚   â””â”€â”€ chatbot.py              # API chatbot
â”‚       â””â”€â”€ services/
â”‚           â”œâ”€â”€ homeapp_db.py           # Service PostgreSQL
â”‚           â”œâ”€â”€ n8n.py                  # Service N8N
â”‚           â”œâ”€â”€ midpoint.py             # Service MidPoint
â”‚           â”œâ”€â”€ llm.py                  # Service LLM (cloud/local)
â”‚           â””â”€â”€ supabase.py             # Service Supabase
â”œâ”€â”€ docker/
â”‚   â””â”€â”€ docker-compose.yml              # Stack complÃ¨te mise Ã  jour
â””â”€â”€ scripts/
    â””â”€â”€ start-full-stack.sh             # Script dÃ©marrage complet


ğŸ”Œ ENDPOINTS DE LA GATEWAY API (http://localhost:8000)
================================================================================

PROVISIONING (/provision):
  POST   /provision/users                    CrÃ©er un utilisateur
  GET    /provision/users/{login}            Obtenir un utilisateur
  GET    /provision/users?q=...              Rechercher des utilisateurs
  PATCH  /provision/users/{login}            Mettre Ã  jour un utilisateur
  POST   /provision/users/{login}/disable    DÃ©sactiver un utilisateur
  POST   /provision/users/{login}/enable     Activer un utilisateur
  DELETE /provision/users/{login}            Supprimer un utilisateur
  POST   /provision/roles/assign             Assigner un rÃ´le
  POST   /provision/roles/revoke             RÃ©voquer un rÃ´le
  GET    /provision/users/{login}/roles      Lister les rÃ´les
  POST   /provision/permissions/assign       Assigner une permission
  POST   /provision/permissions/revoke       RÃ©voquer une permission
  GET    /provision/users/{login}/permissions  Lister les permissions

WORKFLOWS (/workflow):
  POST   /workflow/pre-provision             DÃ©clencher prÃ©-provisioning
  POST   /workflow/post-provision            DÃ©clencher post-provisioning
  POST   /workflow/callback/approval         Callback approbation (N8N)
  POST   /workflow/callback/review           Callback revue (N8N)
  GET    /workflow/requests/pending          Lister demandes en attente
  POST   /workflow/midpoint/hook             Hook MidPoint

CHATBOT (/chat):
  POST   /chat/message                       Envoyer un message au chatbot
  GET    /chat/health                        Ã‰tat du chatbot/LLM
  POST   /chat/direct-action                 Action directe (test)


ğŸ“Š BASE DE DONNÃ‰ES HOME APP
================================================================================

Tables principales:
  â€¢ users              - Comptes utilisateurs
  â€¢ permissions        - Permissions granulaires (crm.read, hr.write, etc.)
  â€¢ roles              - RÃ´les (USER, AGENT_COMMERCIAL, IT_ADMIN, etc.)
  â€¢ role_permissions   - Liaison rÃ´le â†” permissions
  â€¢ user_roles         - Assignation utilisateur â†” rÃ´les
  â€¢ user_permissions   - Permissions directes (bypass rÃ´les)

Tables workflows:
  â€¢ provisioning_requests  - Demandes de provisioning
  â€¢ approval_steps         - Ã‰tapes d'approbation
  â€¢ audit_log              - Journal d'audit

Fonctions SQL:
  â€¢ upsert_user()                    - CrÃ©er/mettre Ã  jour utilisateur
  â€¢ assign_role_to_user()            - Assigner un rÃ´le
  â€¢ revoke_role_from_user()          - RÃ©voquer un rÃ´le
  â€¢ get_user_effective_permissions() - Toutes permissions d'un user
  â€¢ user_has_permission()            - VÃ©rifier une permission


âš™ï¸ WORKFLOWS N8N
================================================================================

1. PRÃ‰-PROVISIONING SIMPLE (1 Ã©tape)
   Webhook â†’ VÃ©rifier si approbation requise â†’ 
   â†’ OUI: Email approbateur â†’ Attendre rÃ©ponse â†’ Provisioning ou Rejet
   â†’ NON: Provisioning direct

2. PRÃ‰-PROVISIONING MULTI-Ã‰TAPES (N niveaux)
   Webhook â†’ Initialiser chaÃ®ne d'approbation â†’
   â†’ Ã‰tape 1 (Manager) â†’ Email â†’ Attendre â†’
   â†’ Ã‰tape 2 (Chef Dept) â†’ Email â†’ Attendre â†’
   â†’ Ã‰tape 3 (Resp. App) â†’ Email â†’ Attendre â†’
   â†’ Toutes OK: Provisioning / Sinon: Rejet

3. POST-PROVISIONING (revue aprÃ¨s crÃ©ation)
   Webhook (aprÃ¨s crÃ©ation compte) â†’
   â†’ Si revue requise: Email de validation â†’ Attendre â†’
   â†’ Si rejet: DÃ©sactiver/supprimer le compte
   â†’ Si validÃ©: Confirmer le provisioning

4. ACTION CHATBOT
   Webhook â†’ VÃ©rifier si approbation requise â†’
   â†’ OUI: DÃ©clencher workflow approbation
   â†’ NON: ExÃ©cuter action via Gateway API


ğŸ¤– CHATBOT IAM
================================================================================

Le chatbot comprend les requÃªtes en langage naturel:

Exemples de commandes:
  "Donne le rÃ´le Agent Commercial Ã  Jean Dupont"
  "Retire les droits admin Ã  tous les employÃ©s du dÃ©partement ComptabilitÃ©"  
  "Quels sont les rÃ´les de marie.martin?"
  "Cherche les utilisateurs du dÃ©partement IT"
  "Liste les rÃ´les disponibles"

Modes LLM supportÃ©s:
  â€¢ CLOUD: OpenAI (GPT-4) ou Anthropic (Claude)
  â€¢ LOCAL: Ollama (Mistral, Llama)

Configuration via variable d'environnement:
  LLM_PROVIDER=cloud   â†’ Utilise OpenAI/Anthropic
  LLM_PROVIDER=local   â†’ Utilise Ollama


ğŸš€ DÃ‰MARRAGE
================================================================================

# DÃ©marrer la stack complÃ¨te
./scripts/start-full-stack.sh

# Ou manuellement
cd docker
docker-compose up -d

# VÃ©rifier les services
docker-compose ps

# Voir les logs
docker-compose logs -f gateway
docker-compose logs -f n8n


ğŸ“§ CONTACT
================================================================================
Projet IGA - BUT3 Informatique
Co-auteur: achibani@gmail.com

================================================================================








